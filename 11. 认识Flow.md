# 认识Flow

Flow 是 facebook 出品的 JavaScript 静态类型检查工具。Vue.js 的源码利用了 Flow 做了静态类型检查，所以了解 Flow 有助于我们阅读源码。

https://flow.org/en/   (Flow 官网自行学习)



## 为什么使用 Flow

JavaScript 是**动态类型**语言，它的灵活性有目共睹。但是过于灵活的副作用是很容易写出非常 隐蔽的隐患代码，在**编译期**甚至看上去都**不会**报错。但在运行阶段就可能出现各种奇怪的bug。

类型检查是当前动态类型语言的发展趋势。所谓类型检查，就是在**编译期**尽早发现（由类型错误引起的）bug，又不影响代码运行（不需要运行时动态检查类型），使编写 JavaScript 具有和编写 Java 等强类型语言相近的体验。

项目越复杂就越需要通过工具的手段来保证项目的维护性和增加代码的可读性。Vue.js 在做 2.0 重构的时候，在ES2015的基础上，除了 ESlint 保证代码风格之外，也引入了 Flow 做静态类型检查。之所以选择 Flow，主要是因为Babel 和 ESlint 都有对应的 Flow 插件以运行语法，可以完全沿用现有的构建配置，非常小成本的改动就可以拥有**静态类型检查**的能力。



## Flow 的工作方式

通常类型检查分成 2 种方式：

- **类型推断**（Type Inference）:

  通过变量使用的上下文来推断出变量类型，然后根据这些推断来检查类型。

- **类型注释**（Type Annotation）:

  事先注释好我们期待的类型，Flow 会基于这些注释来判断。

  第二种方式比较常用。

  

### 类型推断 

它不需要任何代码修改即可进行类型检查，最小化开发者的工作量。它不会强制你改变开发习惯，因为它会**自动**推断出**变量的类型**。这就是所谓的类型推断，Flow 最重要的特性之一。

通过一个简单例子说明一下：

```typescript
/*@flow*/

function split(str) {
    return str.split(' ')
}

split(11)
```

Flow 检查上述代码后会报错，因为函数 split 期待的参数是字符串，而我们输入了数字 。



### 类型注释

如上所术，类型推断是 Flow 最有用的特性之一，不需要编写类型注释就能获取有用的反馈。但在某些特定的场景下，添加类型注释可以提供更好更明确的检查依据。

考虑如下代码：

```typescript
/*@flow*/

function add(x, y) {
    return x + y
}

add('Hello', 11)
```

Flow 检查上述代码时检查不出任何错误，因为从语法层面考虑， + 既可以用在字符串上，也可以用在数字上，我们并没有明确指出 add() 的参数必须为数字 。

在这种情况下，我们可以借助**类型注释**来**指明期望的类型**。类型注释以冒号 : 开头，可以在函数参数，返回值，变量声明中使用。

如果我们在上段代码中添加类型注释，就会变成如下：

```typescript
/*@flow*/

function add(x: number, y: number): number {
    return x + y
}

add('Hello', 11)
```

现在 Flow 就能检查出错误，因为函数参数的期待类型为数字，而我们提供了字符串。

上面的例子就是针对函数的类型注释。接下来我们来看看 Flow 能运行的一些常见的类型注释。



#### 数组

```typescript
/*@flow*/

var arr: Array<number> = [1,2,3]

arr.push('Hello')
```

数组类型注释的格式是 Array\<T>，T 表示数组中每项的数据类型。在上述代码中， arr 是每项均为数字的数组。如果我们给这个数组添加了一个字符串，Flow 能检查出错误。









