# 模块热替换

模块热替换（Hot Module Replacement 或 HMR） 是 webpack 提供的最有用的功能之一。它允许在运行时更新各种模块，而无需进行完全刷新。本页面重点介绍实现，而概念页面提供了更多关于它的工作原理以及为什么它有用的细节。https://www.webpackjs.com/concepts/hot-module-replacement/

HMR 不适用于生产环境，这意味着它应该只在开发环境中使用。更多详情信息，请查看生产环境构建指南。https://www.webpackjs.com/guides/production/



## 启用 HMR

启用此功能实际上相当简单。而我们要做的，就是更新 webpack-dev-server 的配置，和使用 webpack 内置的 HMR 插件。

如果你使用了 webpack-dev-middleware 而没有使用 webpack-dev-server，请使用 webpack-hot-middleware package 包，以在你的自定义服务或者应用程序上启用HMR。

webpack.config.js

```js
const webpack = require('webpack'); // 添加这一行
module.exports = {
    devServer: {
    	contentBase: './dist',
        hot: true // 添加这一行
	},
    plugins: [
        // 添加下面两行
        new webpack.NamedModulesPlugin(),
        new webpack.HotModuleReplacementPlugin()
    ]
}
```

你可以通过命令来修改 webpack-dev-server 的配置： `webpack-dev-server --hotOnly`

注意，我们还添加了 NameModulesPlugin，以便更容易查看要修补（patch）的依赖。在起步阶段，我们将通过在命令行中运行 `npm start` 来启动 dev server。

现在，我们来修改 index.js，以便当 print.js 内部发生变更时可以告诉 webpack 接受更新的模块。

index.js

```js
import printMe from './print.js';

// 增加下面几行
if(module.hot) {
    module.hot.accept('./print.js', function() {
        console.log('Accepting the updated printMe module!');
        printMe();
    })
}
```

更改 print.js 中 console.log 的输出内容，你将会在浏览器中看到如下的输出

```js
[HMR] Waiting for update signal from WDS...
main.js:4395 [WDS] Hot Module Replacement enabled.
+ 2main.js:4395 [WDS] App updated. Recompiling...
+ main.js:4395 [WDS] App hot update...
+ main.js:4330 [HMR] Checking for updates on the server...
+ main.js:10024 Accepting the updated printMe module!
+ 0.4b8ee77….hot-update.js:10 Updating print.js...
+ main.js:4330 [HMR] Updated modules:
+ main.js:4330 [HMR]  - 20
+ main.js:4330 [HMR] Consider using the NamedModulesPlugin for module names.
```





## HMR 修改样式表

借助于 style-loader 的帮助，CSS的模块热替换实际上是相当简单的。当更新CSS依赖模块时，此 loader 在后台使用 module.hot.accept 来修补（patch）<style标签。

所以，可以使用以下命令安装两个 loader:

```
npm install --save-dev style-loader css-loader
```

接下来我们来更新 webpack 的配置，让这两个loader 生效。

webpack.config.js

```js
module.exports = {
	module: {
        rules: [
            {
                test:/\.css$/,
                use: ['style-loader', 'css-loader']
            }
        ]
    }
}
```

热加载样式表，与将其导入模块一样简单：

在项目根目录下新建 styles.css

styles.css

```css
body {
	background: blue;
}
```

index.js

```js
import './styles.css';
```

将 body 上的样式修改为 background: red，你应该可以立即看到页面的背景颜色随之更改，而无需完全刷新。



## 其他代码和框架

社区还有许多其他 loader 和 示例，可以使 HMR 与各种框架和库平滑地进行交互...

- React Hot Loader：实时调整 react 组件

- Vue Loader ：此 loader 支持用于 vue 组件的HMR，提供开箱即用体验。

- Elm Hot Loader： 支持 Elm程序语言的 HMR

- Redux HMR： 无需 loader 或插件！只需要对 main store 文件进行简单的修改

- Angular HMR：没有必要使用 loader！只需要对主要的 NgModule 文件进行简单的修改，由HMR API完全控制。

  

如果你知道任何其他 loader 或插件，能够有助于或增加模块热替换（Hot Module Replacement），请提交一个 pull request以添加到此列表中。



























